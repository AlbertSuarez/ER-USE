-- $ProjectHeader: use 0.393 Wed, 02 Nov 2015 10:00:28 +0200 opti $

model ER13

-- classes

class Date
attributes
  dia : Integer
  mes : Integer
  any : Integer
operations
  esPosteriorA(d : Date) : Boolean =
    (self.any > d.any or
     self.any = d.any and self.mes > d.mes or
     self.any = d.any and self.mes = self.mes and self.dia > d.dia)
  esAnteriorA(d : Date) : Boolean =
    (self.any < d.any or
     self.any = d.any and self.mes < d.mes or
     self.any = d.any and self.mes = self.mes and self.dia < d.dia)
  esIgualA(d : Date) : Boolean =
    (self.any = d.any and
     self.mes = d.mes and
     self.dia = d.dia)
end

class Usuari
attributes
  dni : String
  email : String
  nom : String
  contrasenya : String
  dataDeAlta : Date
  estaConectat : Boolean

end

class Pacient < Usuari
attributes
  estaSubscrit : Boolean
  dataDeUltimPagament : Date
  dataDeCaducitatDelServei : Date
  numeroDeCompteBancari : String
  urlICal : String
  clauDAutentificacioGoogle : String
end

class PersonalSanitari < Usuari
attributes

end

class Cuidador < PersonalSanitari
attributes

end

class Metge < PersonalSanitari
attributes
  idententificacioSanitaria : Integer
end

class Farmacia < Usuari
attributes
  adreca : String
end

class Tractament
attributes
  durada : Integer
end

class Medicament
attributes
  codi : Integer
  nom : String
end

class Notificacio
attributes
  missatge : String
  estaConfirmat : Boolean
  data : Date
  tempsAjornament : Integer
  nombreDeRecordatoris : Integer
  nombreMaximDeRecordatoris : Integer
end

class Promocio
attributes
  nom : String
  dataDeInici : Date
  dataDeFi : Date
end

class Apat
attributes
  hora : Integer
  tipus : TipusApat
end


--Enumerations

enum TipusApat {Esmorzar, Dinar, Sopar}

-- association classes

associationclass Medicacio between
   Medicament[*]
   Tractament[*]
attributes
   periodicitat : Integer
   dosiEnMG : Integer
end

associationclass Missatge between
  Usuari [*] role remitent
  Seguiment[*] role conversacio
attributes
  cos : String
end

associationclass Seguiment between
   Pacient[*] role pacient
   PersonalSanitari[*] role personalSanitari
attributes

end

associationclass Stock between
   Medicament[*]
   Pacient[*]
attributes
  quantitat : Integer
end

-- associations

association Fa between
  Pacient[*]
  Apat[*]
end

association Segueix between
  Pacient[*]
  Tractament[*]
end

association Rep between
  Usuari[1]
  Notificacio[*]
end

association Ofereix between
  Farmacia[*]
  Promocio[*]
end

-- OCL constraints

constraints

context Usuari
	-- Dos usuaris no poden tenir el mateix email
	inv teUnEmailUnic:
		Usuari.allInstances()->isUnique(email)

	-- Una contrasenya no pot tenir menys de 8caràcters
	inv teUnaContrasenyaAmbMidaDeterminada:
		self.contrasenya.size()>8

	-- NI ZORRA COM FER AQUEST

	-- Un usuari no pot rebre un avis abans de donar-se d’alta
	--inv seHaDonatDeAltaAbansDeRebreUnAvis:
		--not Pacient.allInstances()->exists(p | p.dataDeAlta.esAnteriorA(p.notificacio.oclAsType(AvisDePresa).data))
		--Pacient.allInstances()-> forAll (p| p.dataDeAlta.esAnteriorA( (p.notificacio.oclAsType(AvisDePresa).data)))
		--not Pacient.allInstances() -> exists (p| p.notificacio.oclAsType(AvisDePresa).data) -> exists (data.esPosteriorA(p.oclAsType(Usuari).dataDeAlta))
		--includes (data.esPosteriorA(p.oclAsType(Usuari).dataDeAlta))

		--notificacio.oclAsType(AvisDePresa).tractament = p.tractament)

context Farmacia

	-- La data d’inici d’una promoció ha de ser major o igual que la data d’alta de la farmacia
	inv teDataDeAltaAnteriorALaDataDeIniciDeLaPromocio:
		not self.promocio->exists(p | p.dataDeInici.esAnteriorA(self.dataDeAlta))

context Promocio

	-- La data d’inici ha de ser menor que la data de fi
	inv teDataDeFiPosteriorALaDataDeInici:
		self.dataDeFi.esPosteriorA(self.dataDeInici)

context Apat

	-- La hora del Apat ha de contenir hores del 0 al 23h
	inv teUnaHoraDeApatReal:
		self.hora >= 0 or self.hora <= 23

context Pacient

	-- La data de Ultim Pagament no pot ser anterior a la data de Alta
	inv	teUnaDataDeUltimPagamentPosteriorALaDataDeAlta:
		self.dataDeUltimPagament <> null and (self.dataDeUltimPagament.esPosteriorA(self.dataDeAlta) or self.dataDeUltimPagament.esIgualA(self.dataDeAlta))

	-- Un pacient subscrit ha de tenir data de pagament i compte bancari
	inv teDataDePagamentINumeroDeCompteSiEstaSubscrit:
		self.estaSubscrit and self.dataDeUltimPagament <> null and self.numeroDeCompteBancari <> null

	-- La data de Caducitat del Servei no pot ser anterior a la data de Alta
	inv	teLaDataDeCaducitatDelServeiPosteriorALaDataAlta:
		self.dataDeCaducitatDelServei.esPosteriorA(self.dataDeAlta) or self.dataDeCaducitatDelServei.esIgualA(self.dataDeAlta)

	-- La data de Caducitat del servei no pot ser anterior a la data de pagament
	inv	teLaDataDeCaducitatPosteriorALaDataDePagament:
		self.dataDeUltimPagament <> null and self.dataDeUltimPagament.esAnteriorA(self.dataDeCaducitatDelServei)

context Tractament

	-- La durada ha de ser positiva
	inv teLaDuradaPositiva:
		self.durada >= 0

context Medicacio

	-- La periodicitat ha de ser positiva
	inv teLaPeriodicitatPositiva:
		self.periodicitat > 0

	-- La dosi en mg ha de ser positiva
	inv teLaDosiEnMGPositiva:
		self.dosiEnMG > 0

context Stock

	-- La quantitat no pot ser negativa
	inv teLaQuantitatPositiva:
		self.quantitat >= 0


context Notificacio

inv recordatorisInferiorAMaxim:
  self.nombreDeRecordatoris < self.nombreMaximDeRecordatoris


context Missatge

inv remitentMisatgeASeguiment:
  self.remitent = self.conversacio.pacient or self.remitent = self.conversacio.personalSanitari

-- Inv de Associacions

	-- Un pacient ha de ser avisat només per una notificació que utilitza el mateix tractament que segueix el pacient
	--context Pacient inv esAvisatPelTractamentQueSegueix:
		--Pacient.allInstances() -> forAll (p| p.notificacio.oclAsType(AvisDePresa).tractament = p.tractament)

	-- Un pacient nomes serà alarmat de la falta del stock que disposa ell
	--context Pacient inv esAvisatDelSeuStock:
		--Pacient.allInstances() -> forAll (p| p.notificacio.oclAsType(AvisDeStock).stock = p.stock)

	-- Un pacient nomes enviarà avisos de seguiment al personal sanitari que el segueixi
		--context PersonalSanitari inv esAvisatDelPacientQueSegueix:
		--Pacient.allInstances() -> forAll (p| p.notificacio.oclAsType(AvisDeSeguiment).personalsanitari = p.personalsanitari)

!new Apat('apat')
!destroy apat
!new Apat('apat1')
!new Apat('apat2')
!new Cuidador('cuidador1')
!new Farmacia('farmacia1')
!new Medicament('medicament1')
!new Metge('metge1')
!new Notificacio('notificacio1')
!new Notificacio('notificacio2')
!new Notificacio('notificacio3')
!new Pacient('pacient1')
!new Promocio('promocio1')
!new Tractament('tractament1')
!pacient1.dni := '1234567A'
!pacient1.nom := 'Pepito'
!pacient1.contrasenya := 'abcdef'
!pacient1.estaConectat := true
!pacient1.estaSubscrit := true
!pacient1.numeroDeCompteBancari := '21004533248928399'
!pacient1.urlICal := 'http://lsf.ical/12893b'
!pacient1.clauDAutentificacioGoogle := '82djsa92ua8j2'
!apat2.hora := 14
!apat1.hora := 21
!insert (pacient1,apat1) into Fa
!insert (pacient1,apat2) into Fa
!farmacia1.dni := 'B2938392'
!farmacia1.email := 'farmacia@falsa.com'
!farmacia1.nom := 'Farmacia Muntane'
!farmacia1.contrasenya := 'muntane123'
!farmacia1.estaConectat := true
!farmacia1.adreca := 'C/ Falsa 123'
!insert (farmacia1,promocio1) into Ofereix
!promocio1.nom := '20% descompte en tractaments'
!tractament1.durada := 15
!insert (pacient1,tractament1) into Segueix
!medicament1.codi := 98765432
!medicament1.nom := 'Amoxicilina'
!insert (medicament1,tractament1) into Medicacio
!Medicacio1.periodicitat := 8
!Medicacio1.dosiEnMG := 600
!insert (medicament1,pacient1) into Stock
!Stock1.quantitat := 12
!insert (pacient1,metge1) into Seguiment
!insert (pacient1,Seguiment1) into Missatge
!insert (metge1,Seguiment1) into Missatge
!Missatge1.cos := 'Te importancia prendre la medicacio abans o despres dels apats'
!Missatge1.cos := 'Te importancia prendre la medicacio abans o despres dels apats?'
!destroy notificacio1
!Missatge2.cos := 'Si, millor despres'
!insert (pacient1,cuidador1) into Seguiment
!insert (cuidador1,Seguiment2) into Missatge
!Missatge3.cos := 'Tot be?'
!insert (cuidador1,notificacio3) into Rep
!notificacio3.estaConfirmat := false
!notificacio3.tempsAjornament := 5
!notificacio3.nombreDeRecordatoris := 0
!notificacio3.nombreMaximDeRecordatoris := 1
!notificacio2.estaConfirmat := false
!notificacio2.tempsAjornament := 5
!notificacio2.nombreDeRecordatoris := 3
!notificacio2.nombreMaximDeRecordatoris := 3
!insert (pacient1,notificacio2) into Rep
!pacient1.contrasenya := 'abcdefghi'
!notificacio2.nombreDeRecordatoris := 2
!pacient1.email := 'correu@fals.com'
!metge1.dni := '55555555'
!metge1.email := 'metge@elmillor.com'
!metge1.nom := 'Sr. Metge'
!metge1.contrasenya := 'socelmillor'
!metge1.estaConectat := false
!metge1.idententificacioSanitaria := 56286456
!metge1.dni := '55555555X'
!cuidador1.dni := '894132I'
!cuidador1.email := 'email@correu.c'
!cuidador1.nom := 'Sr. Cuidador'
!cuidador1.contrasenya := 'noempaguen'
!cuidador1.estaConectat := true
!new Date('date1')
!pacient1.dataDeAlta := date1
!new Date('date2')
!new Date('date3')
!new Date('date4')
!new Date('date5')
!new Date('date6')
!date1.dia := 1
!date1.mes := 12
!date1.any := 2015
!date2.dia := 2
!date2.mes := 12
!date2.any := 2015
!date3.dia := 2
!date3.mes := 12
!date3.any := 2016
!date4.dia := 3
!date4.mes := 12
!date4.any := 2016
!date5.dia := 5
!date5.mes := 12
!date5.any := 2015
!date4.any := 2015
!date6.dia := 8
!date6.mes := 12
!date6.any := 2016
!pacient1.dataDeUltimPagament := date2
!pacient1.dataDeCaducitatDelServei := date3
!promocio1.dataDeInici := date2
!promocio1.dataDeFi := date3
!farmacia1.dataDeAlta := date1
!metge1.dataDeAlta := date1
!cuidador1.dataDeAlta := date1
!notificacio2.missatge := 'Amoxicilina 600mg'
!notificacio2.data := date4
!notificacio3.missatge := 'Ha oblidat 5 dosis'
!notificacio3.data := date4
!destroy date5
!destroy date6
!date4.dia := 10
!promocio1.dataDeInici := date4
!promocio1.dataDeInici := date2
!farmacia1.dataDeAlta := date4
!farmacia1.dataDeAlta := date1
